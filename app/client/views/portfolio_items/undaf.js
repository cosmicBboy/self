var topics = [
  'Human Rights',
  'Sustainable Transport',
  'Climate Change',
  'Energy',
  'Employment and Social Protection',
  'Oceans and Seas',
  'Global Governance',
  'Food Security and Sustainable Agriculture',
  'Rule of Law',
  'Sustainable Cities',
  'Needs of Countries in Special Situations',
  'Promoting Equality and Social Inclusion',
  'Global Partnerships',
  'Desertification, Land Degradation and Drought',
  'Means of Implementation',
  'Poverty Eradication',
  'Youth, Education, and Culture',
  'Water and Sanitation',
  'Sustainable Economic Growth',
  'Health and Population Dynamics',
  'Peace-building',
  'Forests and Biodiversity',
  'Macroeconomic Policy Questions',
  'Disaster Risk Reduction',
  'Sustainable Consumption and Production',
  'Sustainable Financing',
]

var undafData = [
    {
        'key': 'India UNDAF 2000',
        'color': "#89c7dd",
        'values': [
          {'y': 0.068727545, 'x': 0, 'doc': 0},
          {'y': 0.2722083, 'x': 1, 'doc': 0},
          {'y': 0.0095390417, 'x': 2, 'doc': 0},
          {'y': 0.089219093, 'x': 3, 'doc': 0},
          {'y': 0.41251945, 'x': 4, 'doc': 0},
          {'y': 0.00799766, 'x': 5, 'doc': 0},
          {'y': 0.35296893, 'x': 6, 'doc': 0},
          {'y': 0.37123737, 'x': 7, 'doc': 0},
          {'y': 0.21760614, 'x': 8, 'doc': 0},
          {'y': 0.035473909, 'x': 9, 'doc': 0},
          {'y': 0.36168283, 'x': 10, 'doc': 0},
          {'y': 0.76574969, 'x': 11, 'doc': 0},
          {'y': 0.17328319, 'x': 12, 'doc': 0},
          {'y': 0.0, 'x': 13, 'doc': 0},
          {'y': 0.43025464, 'x': 14, 'doc': 0},
          {'y': 0.59176731, 'x': 15, 'doc': 0},
          {'y': 0.22814162, 'x': 16, 'doc': 0},
          {'y': 0.0035743807, 'x': 17, 'doc': 0},
          {'y': 0.74044818, 'x': 18, 'doc': 0},
          {'y': 0.2407409, 'x': 19, 'doc': 0},
          {'y': 0.042285044, 'x': 20, 'doc': 0},
          {'y': 0.0, 'x': 21, 'doc': 0},
          {'y': 0.78675288, 'x': 22, 'doc': 0},
          {'y': 0.29516727, 'x': 23, 'doc': 0},
          {'y': 0.14866239, 'x': 24, 'doc': 0},
          {'y': 0.34718299, 'x': 25, 'doc': 0},
        ]
    },
    {
        'key': 'India UNDAF 2008-2012',
        'color': "#4F99B4",
        'values': [
          {'y': 0.11690038, 'x': 0, 'doc': 1},
          {'y': 0.4088316, 'x': 1, 'doc': 1},
          {'y': 0.034986876, 'x': 2, 'doc': 1},
          {'y': 0.096438743, 'x': 3, 'doc': 1},
          {'y': 0.46698609, 'x': 4, 'doc': 1},
          {'y': 0.16931155, 'x': 5, 'doc': 1},
          {'y': 0.58530551, 'x': 6, 'doc': 1},
          {'y': 0.53112823, 'x': 7, 'doc': 1},
          {'y': 0.41069189, 'x': 8, 'doc': 1},
          {'y': 0.065706596, 'x': 9, 'doc': 1},
          {'y': 0.46424061, 'x': 10, 'doc': 1},
          {'y': 0.48479253, 'x': 11, 'doc': 1},
          {'y': 0.16826585, 'x': 12, 'doc': 1},
          {'y': 0.15456474, 'x': 13, 'doc': 1},
          {'y': 0.59796011, 'x': 14, 'doc': 1},
          {'y': 0.66765159, 'x': 15, 'doc': 1},
          {'y': 0.25913382, 'x': 16, 'doc': 1},
          {'y': 0.15719345, 'x': 17, 'doc': 1},
          {'y': 0.80661076, 'x': 18, 'doc': 1},
          {'y': 0.33177993, 'x': 19, 'doc': 1},
          {'y': 0.092617758, 'x': 20, 'doc': 1},
          {'y': 0.15456474, 'x': 21, 'doc': 1},
          {'y': 0.52419055, 'x': 22, 'doc': 1},
          {'y': 0.54672396, 'x': 23, 'doc': 1},
          {'y': 0.35650247, 'x': 24, 'doc': 1},
          {'y': 0.25612348, 'x': 25, 'doc': 1},
        ]
    },
    {
        'key': 'India UNDAF 2013-2017',
        'color': "#2b6c84",
        'values': [
          {'y': 0.089070708, 'x': 0, 'doc': 2},
          {'y': 0.40254226, 'x': 1, 'doc': 2},
          {'y': 0.14516643, 'x': 2, 'doc': 2},
          {'y': 0.097091518, 'x': 3, 'doc': 2},
          {'y': 0.53877187, 'x': 4, 'doc': 2},
          {'y': 0.17473365, 'x': 5, 'doc': 2},
          {'y': 0.43229032, 'x': 6, 'doc': 2},
          {'y': 0.56423998, 'x': 7, 'doc': 2},
          {'y': 0.29136214, 'x': 8, 'doc': 2},
          {'y': 0.051799547, 'x': 9, 'doc': 2},
          {'y': 0.47800669, 'x': 10, 'doc': 2},
          {'y': 0.60214126, 'x': 11, 'doc': 2},
          {'y': 0.12400868, 'x': 12, 'doc': 2},
          {'y': 0.16296856, 'x': 13, 'doc': 2},
          {'y': 0.45006257, 'x': 14, 'doc': 2},
          {'y': 0.72239113, 'x': 15, 'doc': 2},
          {'y': 0.25645521, 'x': 16, 'doc': 2},
          {'y': 0.16478685, 'x': 17, 'doc': 2},
          {'y': 0.75272524, 'x': 18, 'doc': 2},
          {'y': 0.38965338, 'x': 19, 'doc': 2},
          {'y': 0.065054722, 'x': 20, 'doc': 2},
          {'y': 0.16296856, 'x': 21, 'doc': 2},
          {'y': 0.63805383, 'x': 22, 'doc': 2},
          {'y': 0.40068826, 'x': 23, 'doc': 2},
          {'y': 0.31878206, 'x': 24, 'doc': 2},
          {'y': 0.17744818, 'x': 25, 'doc': 2},
        ]
    }
]

Meteor.subscribe('data');

//Generate some nice data.
function exampleData() {
  return Meteor.stream_layers(3,10+Math.random()*100,.1).map(function(data, i) {
    return {
      key: 'Stream #' + i,
      values: data
    };
  });
}

// var chart = nv.models.multiBarChart()
//   .duration(350)
//   .reduceXTicks(false)   //If 'false', every single x-axis tick label will be rendered.
//   .rotateLabels(0)      //Angle to rotate x-axis labels.
//   .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
//   .groupSpacing(0.3)    //Distance between each group of bars.
//   .stacked(true)
// ;

var chart = nv.models.multiBarHorizontalChart()
  .x(function(d) { return topics[d.x] })
  .y(function(d) { return d.y })
  .margin({top: 30, left: 300, bottom: 50, right: 100})
  // .groupSpacing(0.75)
  // .showValues(true)           //Show bar value next to each bar.
  .tooltips(true)             //Show tooltips on hover.
  .showControls(true)        //Allow user to switch between "Grouped" and "Stacked" mode.
  .width(1000)
  // .groupSpacing(0.5)
  // .barColor(function (d, i) {
  //   var chartColors = ["#D67777","#4F99B4","#111111"];
  //   // console.log(d);
  //   return chartColors[d.doc];
  // })
  ;

chart.tooltipContent(function (key, i, e, graph) {
  // console.log(key, i, e, graph);
  var header = "<p><h4>" + i + "</h4></p>"
  var caption = "<p>" + key + "</p>"
  var value = "<p>Alignment Score: " + graph.value + "</p>"
  return  header + caption + value
});

Template.undaf.onRendered(function () {

  window.scroll(0, 0);

  nv.addGraph(function() {

      // chart.xAxis.tickValues(topics);

      // chart.xAxis
      //     .tickFormat(d3.format(',f'));

      chart.yAxis
          .tickFormat(d3.format(',.1f'));

      chart.multibar.barColor = function() {
        return false;
      };

      chart.legend.color(function(d,i) {
        console.log(d);
        console.log(i);
      });

      // console.log(chart.multibar.barColor());
      // console.log(undafData);
      d3.select('#chart svg')
          .datum(undafData)
          .call(chart);

      nv.utils.windowResize(function() { 
        chart.update; 
      });

      return chart;
  });

  // this.autorun(function() {
  //   d3.select('#chart svg')
  //       .datum(exampleData())
  //       .call(chart);

  //   chart.update;
  // });

});

Template.undaf.helpers({
  title : function(arg) {
    if (arg) {
      return arg;
    }
    return false;
  }
});

Template.undaf.events({
  'click #generate-data': function() {
    console.log(exampleData());
    d3.select('#chart svg')
      .datum(exampleData())
      .call(chart);
  }
});